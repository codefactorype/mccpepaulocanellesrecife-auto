<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Balanço Financeiro Mensal</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin:0; padding:0; }
    body { font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:#F9F9F9; color:#333; }
    h1,h2 { text-align:center; color:#404040; margin-bottom:20px; }
    .container { max-width:1100px; margin:30px auto; padding:20px; background:#FFF; border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,.1); }
    label { display:block; margin-bottom:8px; font-weight:bold; }
    textarea { width:100%; height:200px; padding:12px; border:1px solid #ccc; border-radius:5px; background:#F5F5F5; resize:none; }
    .btn { width:100%; padding:15px; margin-top:10px; font-size:18px; font-weight:bold;
           background:#454545; color:#F9F9F9; border:none; border-radius:5px; cursor:pointer; transition:.2s; }
    .btn:hover { background:#404040; transform:scale(1.02); }
    #errorMsg { color:red; text-align:center; margin-top:10px; font-weight:bold; }
    table { width:100%; border-collapse:collapse; margin:20px 0; border-radius:8px; overflow:hidden; box-shadow:0 4px 6px rgba(0,0,0,.1); }
    th, td { padding:12px 20px; text-align:center; font-size:1em; }
    th { background:#454545; color:#F9F9F9; text-transform:uppercase; }
    tr:nth-child(even) { background:#F5F5F5; }
    tr:hover { background:#E9ECEF; }
    .summary { max-width:700px; margin:20px auto; padding:20px; background:#FFF; border:1px solid #DDD; border-radius:10px; box-shadow:0 4px 6px rgba(0,0,0,.1); }
    .summary p { margin:8px 0; font-size:1.1em; }
    .summary strong { color:#404040; }
    .account-info { margin-bottom:20px; padding:15px; background:#FFF; border:1px solid #DDD; border-radius:8px; }
    .account-info p { margin:6px 0; font-size:1.1em; }
    .account-info strong { color:#404040; }
    footer { text-align:center; padding:20px; background:#454545; color:#F9F9F9; margin-top:40px; font-size:.9em; }
  </style>
</head>
<body>

  <header>
    <h1>Balanço Financeiro Mensal</h1>
  </header>

  <div class="container">
    <label for="inputData">Cole aqui seus dados (Dados da Conta + Lançamentos):</label>
    <textarea id="inputData" placeholder="Dados da Conta&#10;Cliente: ...&#10;Agência: ...&#10;Conta: ...&#10;&#10;Lançamentos&#10;31/05/2024 Saldo Anterior +12.433,52&#10;03/06/2024 Transferência +320,00 RILDA MARIA SITONIO DOMI&#10;..."></textarea>
    <button class="btn" id="exibirTabelaBtn">Importar Dados</button>
    <div id="errorMsg" role="alert" aria-live="assertive"></div>
  </div>

  <div id="outputContainer" class="container" style="display:none;" aria-live="polite">
    <h2>Dados da Conta</h2>
    <div class="account-info">
      <p><strong>Cliente:</strong> <span id="accountCliente">–</span></p>
      <p><strong>Agência:</strong> <span id="accountAgencia">–</span></p>
      <p><strong>Conta:</strong> <span id="accountConta">–</span></p>
    </div>

    <h2>Receitas</h2>
    <table id="revenueTable">
      <thead><tr><th>Data</th><th>Tipo</th><th>Valor</th><th>Descrição</th></tr></thead>
      <tbody></tbody>
    </table>

    <h2>Despesas</h2>
    <table id="expenseTable">
      <thead><tr><th>Data</th><th>Tipo</th><th>Valor</th><th>Descrição</th></tr></thead>
      <tbody></tbody>
    </table>

    <div class="summary" id="summaryContainer">
      <h2>Resumo Financeiro</h2>
      <p><strong>Saldo Anterior:</strong> <span id="saldoAnterior">–</span></p>
      <p><strong>Total de Receitas:</strong> <span id="totalReceitas">–</span></p>
      <p><strong>Total de Despesas:</strong> <span id="totalDespesas">–</span></p>
      <p><strong>Saldo Final:</strong> <span id="saldoFinal">–</span></p>
      <p><strong>Resultado no Período:</strong> <span id="resultadoPeriodo">–</span></p>
    </div>

    <button class="btn" id="gerarPDFBtn">Gerar PDF</button>
  </div>

  <footer>© 2024</footer>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.3.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.14/jspdf.plugin.autotable.min.js"></script>
  <script>
    function processData() {
      const lines = document.getElementById("inputData").value.trim().split("\n");
      const errorMsg = document.getElementById("errorMsg");
      errorMsg.textContent = "";

      // Extrair metadados
      let cliente="", agencia="", conta="";
      lines.forEach(l => {
        if (/^Cliente:/i.test(l))    cliente = l.split(/Cliente:/i)[1].trim();
        if (/^Agência:/i.test(l))    agencia = l.split(/Agência:/i)[1].trim();
        if (/^Conta:/i.test(l))      conta   = l.split(/Conta:/i)[1].trim();
      });
      if (!cliente || !agencia || !conta) {
        errorMsg.textContent = "Erro de parsing: verifique Cliente, Agência e Conta.";
        return;
      }

      // Regex de lançamentos: Data Tipo Valor Descrição
      const regex = /^(\d{2}\/\d{2}\/\d{4})\s+(.+?)\s+([\+\-][\d\.\,]+)\s*(.*)$/;
      const revenues = [], expenses = [];
      let saldoAnterior = "", saldoFinal = "";

      lines.forEach(l => {
        const m = l.match(regex);
        if (!m) return;
        const [, date, type, rawValue, desc] = m;
        const value = rawValue;
        const isPos = rawValue.startsWith("+");
        const keyType = type.toLowerCase();
        if (keyType.includes("saldo anterior")) {
          saldoAnterior = value;
        } else if (keyType.includes("saldo final")) {
          saldoFinal = value;
        } else if (isPos) {
          revenues.push([date, type, value, desc]);
        } else {
          expenses.push([date, type, value, desc]);
        }
      });

      // KPIs
      const sumArr = arr => arr.reduce((s,r)=>
        s + parseFloat(r[2].replace(/\./g,"").replace(/,/,".")), 0
      ,0);
      const totalRec = sumArr(revenues).toLocaleString("pt-BR",{minimumFractionDigits:2});
      const totalDesp = sumArr(expenses).toLocaleString("pt-BR",{minimumFractionDigits:2});
      const resultado = (sumArr(revenues)-sumArr(expenses))
        .toLocaleString("pt-BR",{minimumFractionDigits:2});

      // Preencher UI
      document.getElementById("accountCliente").textContent = cliente;
      document.getElementById("accountAgencia").textContent = agencia;
      document.getElementById("accountConta").textContent   = conta;
      const fill = (id, arr) => {
        const body = document.querySelector(`#${id} tbody`);
        body.innerHTML = arr.map(r=>
          `<tr><td>${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td><td>${r[3]}</td></tr>`
        ).join("") || `<tr><td colspan="4">—</td></tr>`;
      };
      fill("revenueTable", revenues);
      fill("expenseTable", expenses);

      document.getElementById("saldoAnterior").textContent    = saldoAnterior;
      document.getElementById("totalReceitas").textContent    = "+ " + totalRec;
      document.getElementById("totalDespesas").textContent    = "- " + totalDesp;
      document.getElementById("saldoFinal").textContent       = saldoFinal;
      document.getElementById("resultadoPeriodo").textContent = (resultado.startsWith("-")? "- ":"+ ") + resultado;

      document.getElementById("outputContainer").style.display = "block";
    }

    function generatePDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit:'pt', format:'a4' });
      doc.setFontSize(12);

      // Header
      doc.setFont("helvetica","bold");
      doc.text("M.CC. Instituto PE. Paulo Canelles do Recife", 297.5, 40, {align:"center"});
      doc.setFont("helvetica","normal");
      doc.text(`Cliente: ${document.getElementById("accountCliente").textContent}`, 60, 70);
      doc.text(`Agência: ${document.getElementById("accountAgencia").textContent}`, 250, 70);
      doc.text(`Conta: ${document.getElementById("accountConta").textContent}`, 400, 70);

      let y = 100;
      const printSection = (title, tableId, color) => {
        doc.setFont("helvetica","bold");
        doc.text(title, 297.5, y, {align:"center"});
        doc.autoTable({
          startY: y + 10,
          head: [[ "Data","Tipo","Valor","Descrição" ]],
          body: Array.from(document.querySelector(`#${tableId} tbody`).rows)
                     .map(r=> [r.cells[0].innerText, r.cells[1].innerText, r.cells[2].innerText, r.cells[3].innerText]),
          theme: "grid",
          headStyles:{ fillColor: color, halign:"center"},
          styles:{ fontSize:10, cellPadding:5, halign:"center"},
          margin:{ left:60, right:60 },
          rowPageBreak:"avoid"
        });
        y = doc.lastAutoTable.finalY + 30;
      };

      printSection("Receitas", "revenueTable", [0,123,255]);
      printSection("Despesas", "expenseTable", [255,77,77]);

      // Resumo
      doc.setFont("helvetica","bold");
      doc.text("Resumo Financeiro", 297.5, y, {align:"center"});
      const resumo = [
        ["Saldo Anterior", document.getElementById("saldoAnterior").textContent],
        ["Total Receitas", document.getElementById("totalReceitas").textContent],
        ["Total Despesas", document.getElementById("totalDespesas").textContent],
        ["Saldo Final",   document.getElementById("saldoFinal").textContent],
        ["Resultado no Período", document.getElementById("resultadoPeriodo").textContent]
      ];
      doc.autoTable({
        startY: y + 10,
        head: [["Item","Valor"]],
        body: resumo,
        theme:"grid",
        headStyles:{ fillColor:[0,123,255], halign:"center"},
        styles:{ fontSize:10, cellPadding:5, halign:"center"},
        margin:{ left:60, right:60 }
      });

      doc.save(`balanco_financeiro.pdf`);
    }

    document.getElementById("exibirTabelaBtn").addEventListener("click", processData);
    document.getElementById("gerarPDFBtn").addEventListener("click", generatePDF);
  </script>
</body>
</html>
